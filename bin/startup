#!/usr/bin/env python
import sys
from pathlib import Path

import mytools as t
from mytools import log

script_name = Path(__file__).name

# Notify on error
sys.excepthook = (
    lambda typ, val, trace: t.cmd(f"""
gdbus call --session \
    --dest org.freedesktop.Notifications \
    --object-path /org/freedesktop/Notifications \
    --method org.freedesktop.Notifications.Notify \
    "Startup" 0 "" "{typ.__name__}: {val}" "Please run '{script_name}' manually" [] "{{'transient': <true>}}" 5000 || true""")
)

# Create autostart desktop file
target_dirpath = Path.home() / ".config/autostart"
target_dirpath.mkdir(parents=True, exist_ok=True)
desktop_filepath = target_dirpath / f"{script_name}.desktop"
if not desktop_filepath.exists():
    log.info(f"create {desktop_filepath}")
    desktop_filepath.write_text(f"""[Desktop Entry]
Type=Application
Exec={__file__}
Hidden=false
NoDisplay=false
X-GNOME-Autostart-enabled=true
Name=Startup
Comment=My Startup Script
""")


# deamon process
log.info("Tampermonkey script server")
port = 3010
root = Path.home() / "proj/tampermonkey-script/src"
t.cmd(
    f'static-web-server --port {port} --root "{root.absolute()}" --cors-allow-origins "*" &'
)
