#!/usr/bin/env python
import shutil
from pathlib import Path

import mytools as t

HEADS = {
    "python": """
import mytools as t
from mytools import log


""",
    "bash": """
set -euo pipefail
if [[ "${1:-}" == "-e" ]]; then
  [ -f ~/.selected_editor ] && . ~/.selected_editor
  "${2:-${EDITOR:-${VISUAL:-$SELECTED_EDITOR}}}" "$0"
  exit 0
fi
#============================#
""",
}


@t.cli("create my script")
class opts:
    create: str = t.arg()


def main():
    if opts.create:
        script_name = opts.create
        if shutil.which(script_name) is not None:
            raise ValueError(f"command already exists: {script_name}")

        script_filepath = Path(__file__).parent / script_name
        if script_filepath.exists():
            raise FileExistsError(script_filepath)

        typ = "python" if t.confirm("Create Python script?") else "bash"
        _ = script_filepath.write_text(f"#!/usr/bin/env {typ}{HEADS[typ]}")
        script_filepath.chmod(script_filepath.stat().st_mode | 0o111)

        t.cmd(f"{t.editor()} {script_filepath}")


main()
