#!/usr/bin/env python
import re
import shutil

import mytools as t
from mytools import log

ROOT = t.HOME / ".config/Code/User"
GLOBAL_STORE = ROOT / "globalStorage"
WORKSPACE_STORE = ROOT / "workspaceStorage"


def session_history():
    dirpath = ROOT / "History"
    if dirpath.exists():
        log.info(f"Remove {dirpath}")
        shutil.rmtree(dirpath)


def unused_workspaces():
    with t.sqlite(GLOBAL_STORE / "state.vscdb") as con:
        histories_str: str = con.execute(
            'SELECT value FROM ItemTable WHERE key="history.recentlyOpenedPathsList"'
        ).fetchone()[0]

    FILEPATH_RE = re.compile(r'(?:file|vscode-remote)://(?:[^"]+)')
    histories = set[str](FILEPATH_RE.findall(histories_str))
    for workspace in WORKSPACE_STORE.iterdir():
        infopath = workspace / "workspace.json"
        info = infopath.read_text()
        matches = FILEPATH_RE.search(info)
        if matches is None:
            raise ValueError(f"No file path found in {infopath}")
        filepath = matches.group(0)
        if filepath not in histories:
            log.info(f"Remove {workspace}")
            shutil.rmtree(workspace)


@t.cli("vscode deleter")
class opts: ...


def main():
    session_history()
    unused_workspaces()


main()
