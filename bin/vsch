#!/usr/bin/env python
import re
import shutil
import sqlite3
from contextlib import closing, contextmanager
from pathlib import Path

import mytools as t
from mytools import log

ROOT = Path.home() / ".config/Code/User"
GLOBAL_STORE = ROOT / "globalStorage"
WORKSPACE_STORE = ROOT / "workspaceStorage"


@contextmanager
def connect_db(dbpath: Path):
    with closing(sqlite3.connect(dbpath)) as con:
        with con:
            yield con


with t.cli("vscode deleter") as arg:

    @arg("-a", action="store_true")
    def all(val: object):
        if val is not True:
            return
        session_history(val)
        unused_workspaces(val)

    @arg("-s", action="store_true")
    def session_history(val: object):
        if val is not True:
            return
        dirpath = ROOT / "History"
        if dirpath.exists():
            log.info(f"Remove {dirpath}")
            shutil.rmtree(dirpath)

    @arg("-w", action="store_true")
    def unused_workspaces(val: object):
        if val is not True:
            return

        with connect_db(GLOBAL_STORE / "state.vscdb") as con:
            histories_str: str = con.execute(
                'SELECT value FROM ItemTable WHERE key="history.recentlyOpenedPathsList"'
            ).fetchone()[0]

        FILEPATH_RE = re.compile(r'(?:file|vscode-remote)://(?:[^"]+)')
        histories = set[str](FILEPATH_RE.findall(histories_str))
        for workspace in WORKSPACE_STORE.iterdir():
            infopath = workspace / "workspace.json"
            info = infopath.read_text()
            matches = FILEPATH_RE.search(info)
            if matches is None:
                raise ValueError(f"No file path found in {infopath}")
            filepath = matches.group(0)
            if filepath not in histories:
                log.info(f"Remove {workspace}")
                shutil.rmtree(workspace)

    # @arg("-ex", action="store_true")
    # def unused_extensions(val: object):
    #     if val is not True:
    #         return

    #     extensions = set[str](
    #         re.findall(
    #             r'"identifier":{"id":"([^"]+)"',
    #             (Path.home() / ".vscode/extensions/extensions.json").read_text(),
    #         )
    #     )
    #     print("\n".join(extensions))
